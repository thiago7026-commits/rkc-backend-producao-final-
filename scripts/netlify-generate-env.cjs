const fs = require("fs");
const path = require("path");

const adminOutputPath = path.join(__dirname, "..", "site", "admin", "env.js");
const rootOutputPath = path.join(__dirname, "..", "site", "env.js");
const supabaseUrl = process.env.SUPABASE_URL || "";
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || "";

if (!supabaseUrl || !supabaseAnonKey) {
  console.warn("[netlify-generate-env] SUPABASE_URL or SUPABASE_ANON_KEY is missing.");
}

const contents =
  `// generated by Netlify build\n` +
  `window.__ENV__ = {\n` +
  `  SUPABASE_URL: ${JSON.stringify(supabaseUrl)},\n` +
  `  SUPABASE_ANON_KEY: ${JSON.stringify(supabaseAnonKey)}\n` +
  `};\n`;

fs.mkdirSync(path.dirname(adminOutputPath), { recursive: true });
fs.writeFileSync(adminOutputPath, contents, "utf8");

fs.mkdirSync(path.dirname(rootOutputPath), { recursive: true });
fs.writeFileSync(rootOutputPath, contents, "utf8");

console.log("[netlify-generate-env] Wrote", adminOutputPath);
console.log("[netlify-generate-env] Wrote", rootOutputPath);
console.log("[netlify-generate-env] SUPABASE_URL present:", Boolean(supabaseUrl));
console.log("[netlify-generate-env] SUPABASE_ANON_KEY present:", Boolean(supabaseAnonKey));
